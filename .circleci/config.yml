version: 2.1
jobs:
  buildanddeploy:
    docker:
      - image: vijyant97/circleci:ubuntu
        environment:
          AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
          AWS_DEFAULT_REGION: $AWS_REGION
    working_directory: ~/workspace/circleci
    steps:
      - checkout
      # ... steps for building/testing app ...

      - setup_remote_docker:
          version: 20.10.14
          docker_layer_caching: true

      # build and push Docker image and deploy to aws-eks
      - run: |
          sudo apt-get update -y 
          sudo usermod -a -G docker circleci
          TAG=0.1.$CIRCLE_BUILD_NUM 
          sudo service start docker         
          sudo docker build -t vijyant97/dev:${TAG} .
      # - run: |    
      #     sudo echo $DOCKER_PASS | docker login -u vijyant97 --password-stdin
      #     sudo docker push vijyant97/dev:${TAG}
      # - run: |    
      #     apt-get update -y          
      #     curl -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.22.6/2022-03-09/bin/linux/amd64/kubectl
      #     sudo chmod +x ./kubectl
      #     sudo mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
      #     aws eks --region eu-west-1 update-kubeconfig --name go-test-cluster
      #     sudo kubectl apply -f service.yaml
      #     sudo kubectl apply -f deployment.yaml

  # deploytoeks:
  #   docker:
  #     - image: amazon/aws-cli
  #       # environment:
  #       #   AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
  #       #   AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
  #       #   AWS_DEFAULT_REGION: $AWS_REGION
  #   working_directory:  ~/workspace/circleci
  #   steps:
  #     - checkout
  #     - run:
  #         name: "Deploying to EKS"
  #         command: |
  #           apt-get update -y
  #           # yum install curl -y
  #           curl -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.22.6/2022-03-09/bin/linux/amd64/kubectl
  #           chmod +x ./kubectl
  #           mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
  #           aws eks --region eu-west-1 update-kubeconfig --name go-test-cluster
  #           kubectl apply -f service.yaml
  #           kubectl apply -f deployment.yaml
        
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - buildanddeploy
      
          
